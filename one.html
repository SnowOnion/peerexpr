<!DOCTYPE html>
<html>
    <head>
        <title>One</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width">
    </head>
    <body>
        <h1 id='h1id'>Dr. One</h1>
        <video id="vv" autoplay="autoplay">Vd</video>
        <h1 id='h1id2'>Dr. Two</h1>
        <video id="vv2" autoplay="autoplay">Vd</video>

        <script>

            function displayProp(obj) {
                var names = "";
                for (var name in obj) {
                    if (typeof obj[name] == "object") {
                        names += displayProp(obj[name]);
                    }
                    else
                    {
                        names += name + ": " + obj[name] + " | ";
                    }
                }
                return names;
            }

            var vele = document.getElementById('vv');
            var vele2 = document.getElementById('vv2');



            //// things to send by websocket or other way. jsoned.
            var osd2send,
                    asd2send,
                    oice2send,
                    aice2send;

            var ws1 = new WebSocket("wss://www.webrtc-experiment.com:8563");////
            ws1.onopen = function() {
                console.log('ws1 open');
            };

            ws1.onmessage = function(evt) {
                console.log('[[ws1 response]]: ' + evt.data);
                if (IS_ANSWER) {////
                    var par = JSON.parse(evt.data.value);
                    rpc.setRemoteDescription(new RTCSessionDescription(par), function() {
                        alert('sdp final~');
                    })
                }
                else if (IS_ICE) {////
                    var par = JSON.parse(evt.data.value);
                    rpc.addIceCandidate(new RTCIceCandidate(par));
                }
                else {
                    console.log('unknown response');
                }
            };

            ws1.onclose = function(evt) {
                console.log("WebSocket1 Closed!");
            };

            ws1.onerror = function(evt) {
                console.log("WebSocket1 Error!");
            };


            window.URL = window.URL || window.webkitURL || window.msURL || window.oURL;
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
            PeerConnection = window.webkitRTCPeerConnection || window.mozRTCPeerConnection;

            navigator.getUserMedia({video: true, audio: true},
            function(localStream) {
                var url = window.URL.createObjectURL(localStream);
                vele.src = url || localStream;

                rpc = new PeerConnection({iceServers: [{url: 'stun:stun.l.google.com:19302'}]});

                rpc.onaddstream = function(evt) {
                    if (!rpc || !evt || !evt.stream) {
                        console.log('wrong when rpc.onaddstream');
                        return;
                    }
                    var url = window.URL.createObjectURL(evt.stream);
                    vele2.src = url || evt.stream;
                };

                rpc.onicecandidate = function(evt) {
                    if (!rpc || !evt || !evt.candidate) {
                        console.log('wrong when rpc.onicecandidate');
                        return;
                    }
                    oice2send = JSON.stringify(evt.candidate);
                    ws1.send(oice2send);////
                };

                rpc.addStream(localStream);

                rpc.createOffer(
                        function(osd) {
                            rpc.setLocalDescription(osd, function() {
                                osd2send = JSON.stringify(osd);
                                ws1.send(osd2send);////
                            });
                        },
                        null,
                        {'mandatory': {'OfferToReceiveAudio': true, 'OfferToReceiveVideo': true}}
                );

            },
                    function(err) {
                        console.log(err);
                    });




        </script>
    </body>
</html>
